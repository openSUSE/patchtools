From: Chaohai Chen <wdhh6@aliyun.com>
Date: Sat, 6 Dec 2025 14:06:16 +0800
Subject: scsi: libsas: Add rollback handling when an error occurs
Git-commit: 362432e9b9aefb914ab7d9f86c9fc384a6620c41
 (partial)
Patch-mainline: v6.19-rc1
Patch-filtered: !drivers/scsi/libsas/sas_init.c !drivers/scsi/libsas/sas_phy.c

In sas_register_phys(), if an error is triggered in the loop process, we
need to roll back the resources that have already been requested.

Add sas_unregister_phys() when an error occurs in sas_register_ha().

[mkp: a few coding style tweaks and address John's comment]

Signed-off-by: Chaohai Chen <wdhh6@aliyun.com>
Reviewed-by: John Garry <john.g.garry@oracle.com>
Link: https://patch.msgid.link/20251206060616.69216-1-wdhh6@aliyun.com
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Acked-by: Barney Rubbel <brubbel@suse.com>
---

 drivers/scsi/libsas/sas_internal.h |    1 +
 1 file changed, 1 insertion(+)

--- a/drivers/scsi/libsas/sas_internal.h
+++ b/drivers/scsi/libsas/sas_internal.h
@@ -54,6 +54,7 @@ void sas_unregister_dev(struct asd_sas_port *port, struct domain_device *dev);
 void sas_scsi_recover_host(struct Scsi_Host *shost);
 
 int  sas_register_phys(struct sas_ha_struct *sas_ha);
+void sas_unregister_phys(struct sas_ha_struct *sas_ha);
 
 struct asd_sas_event *sas_alloc_event(struct asd_sas_phy *phy, gfp_t gfp_flags);
 void sas_free_event(struct asd_sas_event *event);


